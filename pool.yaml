blueprint:
  name: "Gestion Pompe Piscine avec Prolongation TempÃ©rature"
  description: >
    Automatisation complÃ¨te pour pompe de piscine avec :
    - Programmation horaire flexible (dÃ©marrage, pause midi optionnelle, arrÃªt)
    - Prolongation automatique si tempÃ©rature eau Ã©levÃ©e
    - Notifications personnalisables (Telegram ou mobile)
    - Surveillance des paramÃ¨tres de qualitÃ© d'eau
  domain: automation
  input:
    # === ENTITÃ‰S PRINCIPALES ===
    pump_switch:
      name: "Switch de la pompe"
      description: "EntitÃ© switch qui contrÃ´le votre pompe de piscine"
      selector:
        entity:
          domain: switch
    
    water_temp_sensor:
      name: "Capteur tempÃ©rature de l'eau"
      description: "Capteur qui mesure la tempÃ©rature de l'eau de la piscine"
      selector:
        entity:
          domain: sensor
          device_class: temperature
    
    lock_boolean:
      name: "Boolean de verrouillage (optionnel)"
      description: "Input boolean pour dÃ©sactiver temporairement l'automation (recommandÃ© pour maintenance)"
      default: {}
      selector:
        entity:
          domain: input_boolean
    
    # === HORAIRES ===
    start_time:
      name: "Heure de dÃ©marrage"
      description: "Heure Ã  laquelle la pompe dÃ©marre le matin"
      default: "09:03:00"
      selector:
        time:
    
    enable_lunch_pause:
      name: "Activer la pause de midi"
      description: "Cochez pour programmer une pause Ã  midi (Ã©conomie d'Ã©nergie)"
      default: true
      selector:
        boolean:
    
    pause_start_time:
      name: "DÃ©but de la pause midi"
      description: "Heure de dÃ©but de la pause (seulement si pause activÃ©e)"
      default: "12:03:00"
      selector:
        time:
    
    pause_end_time:
      name: "Fin de la pause midi"
      description: "Heure de reprise aprÃ¨s la pause (seulement si pause activÃ©e)"
      default: "13:33:00"
      selector:
        time:
    
    normal_stop_time:
      name: "Heure d'arrÃªt normal"
      description: "Heure d'arrÃªt normale de la pompe (peut Ãªtre prolongÃ©e selon tempÃ©rature)"
      default: "20:01:00"
      selector:
        time:
    
    # === PROLONGATION TEMPÃ‰RATURE ===
    temp_threshold:
      name: "Seuil de tempÃ©rature pour prolongation"
      description: "TempÃ©rature eau (Â°C) qui dÃ©clenche une prolongation de filtration"
      default: 30
      selector:
        number:
          min: 25
          max: 35
          step: 0.5
          unit_of_measurement: "Â°C"
    
    extension_duration:
      name: "DurÃ©e de prolongation"
      description: "Nombre d'heures supplÃ©mentaires de filtration si tempÃ©rature Ã©levÃ©e"
      default: 2
      selector:
        number:
          min: 0.5
          max: 4
          step: 0.5
          unit_of_measurement: "h"
    
    # === CAPTEURS OPTIONNELS POUR SURVEILLANCE ===
    ph_sensor:
      name: "Capteur pH (optionnel)"
      description: "Capteur pH pour suivi qualitÃ© eau dans les notifications"
      default: {}
      selector:
        entity:
          domain: sensor
    
    redox_sensor:
      name: "Capteur Redox (optionnel)"
      description: "Capteur Redox/ORP pour suivi dÃ©sinfection dans les notifications"
      default: {}
      selector:
        entity:
          domain: sensor
    
    temp_ambient_sensor:
      name: "Capteur tempÃ©rature ambiante (optionnel)"
      description: "TempÃ©rature pool house ou extÃ©rieure pour contexte"
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: temperature
    
    additional_sensor_1:
      name: "Capteur supplÃ©mentaire 1 (optionnel)"
      description: "Capteur libre pour surveillance (chlore, conductivitÃ©, etc.)"
      default: {}
      selector:
        entity:
          domain: sensor
    
    additional_sensor_2:
      name: "Capteur supplÃ©mentaire 2 (optionnel)"
      description: "Capteur libre pour surveillance (turbiditÃ©, niveau, etc.)"
      default: {}
      selector:
        entity:
          domain: sensor
    
    # === NOTIFICATIONS ===
    notification_type:
      name: "Type de notification"
      description: "Choisissez comment recevoir les notifications d'Ã©tat"
      default: "telegram"
      selector:
        select:
          options:
            - value: "telegram"
              label: "Telegram"
            - value: "mobile"
              label: "Application mobile"
            - value: "both"
              label: "Telegram + Mobile"
    
    mobile_device:
      name: "Appareil mobile (si sÃ©lectionnÃ©)"
      description: "Service de notification mobile (ex: notify.mobile_app_mon_telephone)"
      default: "notify.mobile_app_s24"
      selector:
        text:

# === VARIABLES CALCULÃ‰ES ===
variables:
  # Calcul heure d'arrÃªt prolongÃ©
  extended_stop_time: >
    {% set normal_time = extension_duration | float(2) %}
    {% set normal_hour = normal_stop_time.split(':')[0] | int %}
    {% set normal_minute = normal_stop_time.split(':')[1] | int %}
    {% set normal_second = normal_stop_time.split(':')[2] | int %}
    {% set extended_hour = normal_hour + normal_time %}
    {% if extended_hour >= 24 %}
      {% set extended_hour = extended_hour - 24 %}
    {% endif %}
    {{ '%02d:%02d:%02d' | format(extended_hour, normal_minute, normal_second) }}
  
  # Construction du message de surveillance
  sensor_status: >
    {% set status_parts = [] %}
    {% set status_parts = status_parts + ['ğŸŒ¡ï¸ Eau : ' + states(water_temp_sensor) + ' Â°C'] %}
    {% if ph_sensor != {} %}
      {% set status_parts = status_parts + ['ğŸ’§ pH : ' + states(ph_sensor)] %}
    {% endif %}
    {% if redox_sensor != {} %}
      {% set status_parts = status_parts + ['âš¡ Redox : ' + states(redox_sensor) + ' mV'] %}
    {% endif %}
    {% if temp_ambient_sensor != {} %}
      {% set status_parts = status_parts + ['ğŸ  TÂ° ambiante : ' + states(temp_ambient_sensor) + ' Â°C'] %}
    {% endif %}
    {% if additional_sensor_1 != {} %}
      {% set sensor_name = state_attr(additional_sensor_1, 'friendly_name') or 'Capteur 1' %}
      {% set unit = state_attr(additional_sensor_1, 'unit_of_measurement') or '' %}
      {% set status_parts = status_parts + ['ğŸ“Š ' + sensor_name + ' : ' + states(additional_sensor_1) + ' ' + unit] %}
    {% endif %}
    {% if additional_sensor_2 != {} %}
      {% set sensor_name = state_attr(additional_sensor_2, 'friendly_name') or 'Capteur 2' %}
      {% set unit = state_attr(additional_sensor_2, 'unit_of_measurement') or '' %}
      {% set status_parts = status_parts + ['ğŸ“Š ' + sensor_name + ' : ' + states(additional_sensor_2) + ' ' + unit] %}
    {% endif %}
    {{ status_parts | join('\n- ') }}

# === DÃ‰CLENCHEURS ===
trigger:
  # DÃ©marrage
  - platform: time
    at: !input start_time
    id: start
  
  # Pause midi (conditionnel)
  - platform: time
    at: !input pause_start_time
    id: pause_start
    enabled: !input enable_lunch_pause
  
  # Reprise aprÃ¨s pause (conditionnel)
  - platform: time
    at: !input pause_end_time
    id: pause_end
    enabled: !input enable_lunch_pause
  
  # VÃ©rification tempÃ©rature + arrÃªt conditionnel
  - platform: time
    at: !input normal_stop_time
    id: temp_check_stop
  
  # ArrÃªt aprÃ¨s prolongation
  - platform: time
    at: "{{ extended_stop_time }}"
    id: extended_stop

# === CONDITIONS ===
condition:
  # VÃ©rification boolean de verrouillage (si fourni)
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ lock_boolean == {} }}"
      - condition: state
        entity_id: !input lock_boolean
        state: "off"

# === ACTIONS ===
action:
  - choose:
      # === DÃ‰MARRAGE ET REPRISE ===
      - conditions:
          - condition: trigger
            id:
              - start
              - pause_end
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input pump_switch
          - service: logbook.log
            data:
              name: "Pompe Piscine"
              message: >
                DÃ©marrage pompe - {{ 'DÃ©but journÃ©e' if trigger.id == 'start' else 'Reprise aprÃ¨s pause midi' }}
      
      # === PAUSE MIDI ===
      - conditions:
          - condition: trigger
            id: pause_start
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input pump_switch
          - service: logbook.log
            data:
              name: "Pompe Piscine"
              message: "Pause midi - Ã‰conomie d'Ã©nergie"
      
      # === VÃ‰RIFICATION TEMPÃ‰RATURE Ã€ L'ARRÃŠT NORMAL ===
      - conditions:
          - condition: trigger
            id: temp_check_stop
        sequence:
          - choose:
              # PROLONGATION si tempÃ©rature Ã©levÃ©e
              - conditions:
                  - condition: numeric_state
                    entity_id: !input water_temp_sensor
                    above: "{{ temp_threshold - 0.1 }}"
                sequence:
                  # Pompe continue (pas d'action)
                  - choose:
                      # Notification Telegram
                      - conditions:
                          - condition: template
                            value_template: "{{ notification_type in ['telegram', 'both'] }}"
                        sequence:
                          - service: telegram_bot.send_message
                            data:
                              message: >
                                ğŸŠ **PROLONGATION FILTRATION** (+{{ extension_duration }}h)
                                ğŸŒ¡ï¸ TempÃ©rature eau : {{ states(water_temp_sensor) }} Â°C (â‰¥ {{ temp_threshold }}Â°C)
                                â° Pompe continue jusqu'Ã  {{ extended_stop_time }} pour optimiser la filtration.
                                
                                ğŸ“Š Ã‰tat actuel :
                                - {{ sensor_status }}
                      
                      # Notification Mobile
                      - conditions:
                          - condition: template
                            value_template: "{{ notification_type in ['mobile', 'both'] }}"
                        sequence:
                          - service: "{{ mobile_device }}"
                            data:
                              title: "ğŸŠ Prolongation Filtration"
                              message: >
                                TempÃ©rature {{ states(water_temp_sensor) }}Â°C â‰¥ {{ temp_threshold }}Â°C. 
                                Pompe continue +{{ extension_duration }}h jusqu'Ã  {{ extended_stop_time }}.
                  
                  - service: logbook.log
                    data:
                      name: "Pompe Piscine"
                      message: >
                        Prolongation {{ extension_duration }}h - TempÃ©rature {{ states(water_temp_sensor) }}Â°C
            default:
              # ARRÃŠT NORMAL si tempÃ©rature acceptable
              - service: switch.turn_off
                target:
                  entity_id: !input pump_switch
              
              - choose:
                  # Notification Telegram
                  - conditions:
                      - condition: template
                        value_template: "{{ notification_type in ['telegram', 'both'] }}"
                    sequence:
                      - service: telegram_bot.send_message
                        data:
                          message: >
                            ğŸŠ Pompe de la piscine **arrÃªtÃ©e** ({{ normal_stop_time }}).
                            ğŸ” Ã‰tat relevÃ© :
                            - {{ sensor_status }}
                  
                  # Notification Mobile
                  - conditions:
                      - condition: template
                        value_template: "{{ notification_type in ['mobile', 'both'] }}"
                    sequence:
                      - service: "{{ mobile_device }}"
                        data:
                          title: "ğŸŠ Pompe ArrÃªtÃ©e"
                          message: >
                            ArrÃªt normal Ã  {{ normal_stop_time }}. 
                            TempÃ©rature eau : {{ states(water_temp_sensor) }}Â°C.
              
              - service: logbook.log
                data:
                  name: "Pompe Piscine"
                  message: >
                    ArrÃªt normal - TempÃ©rature {{ states(water_temp_sensor) }}Â°C (< {{ temp_threshold }}Â°C)
      
      # === ARRÃŠT APRÃˆS PROLONGATION ===
      - conditions:
          - condition: trigger
            id: extended_stop
        sequence:
          # VÃ©rifier que la pompe est encore ON (prolongation Ã©tait active)
          - condition: state
            entity_id: !input pump_switch
            state: "on"
          
          - service: switch.turn_off
            target:
              entity_id: !input pump_switch
          
          - choose:
              # Notification Telegram
              - conditions:
                  - condition: template
                    value_template: "{{ notification_type in ['telegram', 'both'] }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      message: >
                        ğŸŠ Pompe de la piscine **arrÃªtÃ©e** ({{ extended_stop_time }} - fin prolongation).
                        ğŸŒ¡ï¸ Filtration prolongÃ©e terminÃ©e (+{{ extension_duration }}h).
                        
                        ğŸ” Ã‰tat final relevÃ© :
                        - {{ sensor_status }}
              
              # Notification Mobile
              - conditions:
                  - condition: template
                    value_template: "{{ notification_type in ['mobile', 'both'] }}"
                sequence:
                  - service: "{{ mobile_device }}"
                    data:
                      title: "ğŸŠ Fin Prolongation"
                      message: >
                        Filtration prolongÃ©e terminÃ©e Ã  {{ extended_stop_time }}. 
                        DurÃ©e supplÃ©mentaire : {{ extension_duration }}h.
          
          - service: logbook.log
            data:
              name: "Pompe Piscine"
              message: >
                Fin prolongation {{ extension_duration }}h - TempÃ©rature finale {{ states(water_temp_sensor) }}Â°C

mode: single
