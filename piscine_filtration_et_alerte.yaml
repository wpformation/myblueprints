blueprint:
  name: "Piscine - Filtration + Alertes avec notification"
  description: >
    GÃ¨re la filtration automatique de la piscine avec diffÃ©rents modes selon la saison (mode Ã‰tÃ© ou Hiver).

    En mode Ã‰tÃ© : filtration avec horaire de dÃ©but, de fin, et pause intermÃ©diaire possible.
    En mode Hiver : filtration simple avec heure de dÃ©but et de fin.

    La pompe peut Ãªtre dÃ©sactivÃ©e manuellement via un interrupteur virtuel.
    En fin de cycle, un message Telegram ou mobile est envoyÃ© avec les relevÃ©s de tempÃ©rature, pH et redox (si capteurs renseignÃ©s).

    En cas de dÃ©passement de seuils critiques (TÂ°, pH, Redox), une alerte est Ã©galement envoyÃ©e.
  domain: automation
  input:
    mode_saison:
      name: Mode de fonctionnement
      description: >
        Choisissez le mode selon la saison :
        - Mode "Filtration Ã©tÃ©" avec possibilitÃ© de pause
        - Mode "Filtration hiver" sans pause
      selector:
        select:
          options:
            - label: "Filtration Ã©tÃ© (avec pause possible)"
              value: ete
            - label: "Filtration hiver (continue)"
              value: hiver

    disable_switch:
      name: ArrÃªt manuel (facultatif)
      description: >
        EntitÃ© de type interrupteur virtuel (input_boolean) permettant de suspendre la filtration
        manuellement, mÃªme si les horaires sont atteints.
      default: null
      selector:
        entity:
          domain: input_boolean

    start_time:
      name: Heure de dÃ©but de filtration
      selector:
        time:
    end_time:
      name: Heure de fin de filtration
      selector:
        time:

    pause_start:
      name: Heure de dÃ©but de pause (mode Ã©tÃ© uniquement)
      description: Plage horaire pendant laquelle la filtration est temporairement coupÃ©e.
      default: ""
      selector:
        time:
    pause_end:
      name: Heure de fin de pause (mode Ã©tÃ© uniquement)
      default: ""
      selector:
        time:

    switch_pompe:
      name: Interrupteur/prise de la pompe de filtration
      selector:
        entity:
          domain: switch

    sensor_temp_eau:
      name: Capteur de tempÃ©rature de l'eau
      selector:
        entity:
          domain: sensor
          device_class: temperature

    sensor_ph:
      name: Capteur de pH (facultatif)
      default: ""
      selector:
        entity:
          domain: sensor

    sensor_redox:
      name: Capteur de Redox (facultatif)
      default: ""
      selector:
        entity:
          domain: sensor

    sensor_temp_poolhouse:
      name: Capteur tempÃ©rature extÃ©rieure (facultatif)
      default: ""
      selector:
        entity:
          domain: sensor

    seuil_temp_eau:
      name: TempÃ©rature max autorisÃ©e de l'eau (en Â°C)
      default: 30
      selector:
        number:
          min: 0
          max: 50
          step: 0.1
    seuil_ph_min:
      name: Seuil pH minimum autorisÃ©
      default: 7.1
      selector:
        number:
          min: 6
          max: 8
          step: 0.05
    seuil_ph_max:
      name: Seuil pH maximum autorisÃ©
      default: 7.4
      selector:
        number:
          min: 6
          max: 8
          step: 0.05
    seuil_redox:
      name: Redox minimum autorisÃ© (en mV)
      default: 600
      selector:
        number:
          min: 0
          max: 1000
          step: 10

    notification_target:
      name: Cible(s) de notification (Telegram, mobile, etc.)
      description: >
        SÃ©lectionnez une ou plusieurs entitÃ©s de notification comme `notify.telegram` ou `notify.mobile_app_xxx`
      selector:
        entity:
          domain: notify
          multiple: true

trigger:
  - platform: time
    at: !input start_time
    id: start
  - platform: time
    at: !input end_time
    id: stop

condition:
  - condition: or
    conditions:
      - condition: template
        value_template: >
          {{ disable_switch == none }}
      - condition: state
        entity_id: !input disable_switch
        state: "off"

action:
  - choose:
      - conditions:
          - condition: trigger
            id: start
          - condition: template
            value_template: >
              {% if mode_saison == 'ete' %}
                {{ (not pause_start or not pause_end) or
                   (now().time() < strptime(pause_start, '%H:%M:%S').time()) or
                   (now().time() > strptime(pause_end, '%H:%M:%S').time()) }}
              {% else %} true {% endif %}
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input switch_pompe

      - conditions:
          - condition: trigger
            id: stop
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input switch_pompe

          - variables:
              t: "{{ states(sensor_temp_eau) | float }}"
              ph: >
                {% if sensor_ph %}{{ states(sensor_ph) | float }}{% else %}none{% endif %}
              redox: >
                {% if sensor_redox %}{{ states(sensor_redox) | float }}{% else %}none{% endif %}
              t_pool: >
                {% if sensor_temp_poolhouse %}{{ states(sensor_temp_poolhouse) | float }}{% else %}none{% endif %}

              rapport: >
                ğŸŠ Pompe de la piscine **arrÃªtÃ©e**.\nğŸ” Ã‰tat relevÃ© :\n
                - ğŸŒ¡ï¸ Eau : {{ t }} Â°C
                {% if ph != none %}- ğŸ’§ pH : {{ ph }}{% endif %}
                {% if redox != none %}- âš¡ Redox : {{ redox }} mV{% endif %}
                {% if t_pool != none %}- ğŸ  TempÃ©rature extÃ©rieure : {{ t_pool }} Â°C{% endif %}

              alertes: >
                {% set lignes = [] %}
                {% if t > seuil_temp_eau %}
                  {% set lignes = lignes + ["- ğŸŒ¡ï¸ TempÃ©rature trop Ã©levÃ©e : " ~ t ~ " Â°C"] %}
                {% endif %}
                {% if ph != none and (ph < seuil_ph_min or ph > seuil_ph_max) %}
                  {% set lignes = lignes + ["- ğŸ’§ pH hors plage : " ~ ph ~ " (attendu entre " ~ seuil_ph_min ~ " et " ~ seuil_ph_max ~ ")"] %}
                {% endif %}
                {% if redox != none and redox < seuil_redox %}
                  {% set lignes = lignes + ["- âš¡ Redox trop faible : " ~ redox ~ " mV (attendu â‰¥ " ~ seuil_redox ~ ")"] %}
                {% endif %}
                {{ lignes | join('\n') }}

          - repeat:
              for_each: !input notification_target
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    message: "{{ rapport }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ alertes | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: !input notification_target
                      sequence:
                        - service: "{{ repeat.item }}"
                          data:
                            message: >
                              âš ï¸ **Alerte Piscine - Valeurs critiques dÃ©tectÃ©es**\n{{ alertes }}\n
                              â¤ Merci de vÃ©rifier la qualitÃ© de lâ€™eau.
mode: single
